(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[681],{4241:function(e,n,t){(window.__NEXT_P=window.__NEXT_P||[]).push(["/[campaignId]/encounter/[encounterId]/edit",function(){return t(4349)}])},4349:function(e,n,t){"use strict";t.r(n),t.d(n,{default:function(){return en}});var r=t(5893),a=t(6574),i=t(9008),l=t.n(i),o=t(1163),s=t(2175),d=t(5861),c=t(6886),u=t(1903),m=t(4054),h=t(3841),x=t(315),p=t(9840),b=t(3321),v=t(7294),j=t(6310),f=t(8054),y=t(4808),g=t(8456),Z=t(9226),N=t(2428),C=t(2535),w=t(6678),I=t.n(w),M=t(4753),P=t.n(M),S=t(7557),_=t.n(S),k=t(9699),T=t(2511),D=t(6761),E=t(480),F=t(6242),O=t(4267),R=t(7383),U=t(9653),V=t(3946),L=t(657),q=t(7645),A=t(6580),J=t(8951),z=t(1425),G=t(948),W=t(9609),H=t(153),Q=t(4505);let B=(0,G.ZP)(u.Z)(e=>{let{theme:n}=e;return{"& input.Mui-disabled":{cursor:"not-allowed",color:n.palette.text.primary,textFillColor:n.palette.text.primary}}}),X=(0,G.ZP)(E.Z)(e=>{let{theme:n}=e;return{"& .MuiFormControlLabel-label.Mui-disabled":{cursor:"not-allowed",color:n.palette.text.primary,textFillColor:n.palette.text.primary}}});function Y(e){let{playerList:n,combatant:t,index:a,onDragEnd:i}=e,[l,o]=(0,v.useState)(!1),d=(0,H.o)(),u=(0,s.u6)(),[j]=(0,f.kU)({variables:{id:t.id},refetchQueries:[f.N8]}),y=(0,Q.y1)(u.handleSubmit.bind(u),250),g=(0,Q.y1)(u.handleSubmit.bind(u),500);return(0,r.jsxs)(C.t.Item,{value:t.id,dragListener:!1,dragControls:d,onDragEnd:i,style:{listStyle:"none",margin:0,marginBottom:16,padding:0,position:"relative"},children:[(0,r.jsx)(F.Z,{children:(0,r.jsxs)(O.Z,{children:[(0,r.jsx)(W.Z,{width:40,children:(0,r.jsx)(k.Z,{onPointerDown:e=>d.start(e),style:{cursor:"grab",position:"absolute",top:"50%",left:8,transform:"translateY(-50%)"}})}),(0,r.jsxs)(c.ZP,{container:!0,spacing:2,alignItems:"center",ml:2,pr:6,mb:-1,children:[(0,r.jsx)(c.ZP,{item:!0,xs:12,md:5,children:(0,r.jsx)(s.gN,{name:"combatants[".concat(a,"].name"),children:e=>{var n;let{field:t,form:i,meta:l}=e,o=!!(null===(n=i.values.combatants[a])||void 0===n?void 0:n.playerId)||i.isSubmitting;return(0,r.jsx)(R.Z,{title:o?"Controlled by Player Preset":void 0,placement:"top",followCursor:!0,children:(0,r.jsx)("span",{children:(0,r.jsx)(B,{required:!0,id:"combatants[".concat(a,"].name"),label:"Name",fullWidth:!0,autoFocus:!0,disabled:o,error:l.touched&&!!l.error,helperText:l.touched?l.error:void 0,...t,onChange:e=>{t.onChange(e),g()}})})})}})}),(0,r.jsx)(c.ZP,{item:!0,xs:8,md:5,children:(0,r.jsx)(s.gN,{name:"combatants[".concat(a,"].playerId"),children:e=>{let{field:t,form:i}=e,l=n.find(e=>e.id===t.value),o=n.filter(e=>(null==l?void 0:l.id)===e.id||!i.values.combatants.map(e=>e.playerId).includes(e.id));return(0,r.jsxs)(m.Z,{fullWidth:!0,children:[(0,r.jsxs)(h.Z,{id:"combatants[".concat(a,"].playerId"),children:["Player Preset"," ",o.length?"":"(No Players Available)"]}),(0,r.jsx)(x.Z,{labelId:"playerIdLabel",id:"combatants[".concat(a,"].playerId"),label:"Player Preset",disabled:!o.length||i.isSubmitting,...t,endAdornment:(0,r.jsx)(T.Z,{sx:{color:"grey.800",marginRight:2,cursor:"pointer",display:t.value?"":"none"},onClick:()=>{i.setFieldValue("combatants[".concat(a,"].playerId"),void 0),y()}}),onChange:e=>{let r=n.find(n=>n.id===e.target.value);t.onChange(e),i.setFieldValue("combatants[".concat(a,"].name"),r.characterName),i.setFieldValue("combatants[".concat(a,"].public"),!0),y()},children:o.map(e=>(0,r.jsxs)(p.Z,{value:e.id,children:[e.playerName," (",e.characterName,")"]},"".concat(a,"_").concat(e.id)))})]})}})}),(0,r.jsx)(c.ZP,{item:!0,xs:2,md:1,sx:{display:"flex",justifyContent:"center"},children:(0,r.jsx)(s.gN,{name:"combatants[".concat(a,"].public"),children:e=>{var n;let{field:t,form:i}=e,l=!!(null===(n=i.values.combatants[a])||void 0===n?void 0:n.playerId)||i.isSubmitting;return(0,r.jsx)(R.Z,{title:l?"Controlled by Player Preset":void 0,placement:"top",followCursor:!0,children:(0,r.jsx)("span",{children:(0,r.jsx)(X,{id:"combatants[".concat(a,"].public"),label:"Public",labelPlacement:"start",control:(0,r.jsx)(U.Z,{color:"primary",checked:t.value,disabled:l,sx:{cursor:l?"not-allowed":"default"},...t,onChange:e=>{t.onChange(e),y()}})})})})}})}),(0,r.jsx)(c.ZP,{item:!0,xs:2,md:1,sx:{display:"flex",justifyContent:"flex-end"},children:(0,r.jsx)(V.Z,{onClick:()=>o(!0),children:(0,r.jsx)(D.Z,{})})})]})]})}),(0,r.jsxs)(L.Z,{open:l,onClose:()=>o(!1),children:[(0,r.jsxs)(q.Z,{children:["Delete combatant ",t.name,"?"]}),(0,r.jsx)(A.Z,{children:(0,r.jsx)(J.Z,{children:"This action cannot be undone."})}),(0,r.jsxs)(z.Z,{children:[(0,r.jsx)(b.Z,{variant:"contained",onClick:()=>o(!1),children:"Cancel"}),(0,r.jsxs)(b.Z,{variant:"contained",onClick:()=>{j(),o(!1)},color:"error",children:[(0,r.jsx)(D.Z,{})," Delete"]})]})]})]},t.id)}function $(e){var n,t,a;let{campaignId:i,encounterId:l,combatants:o}=e,{data:d}=(0,f.mU)({variables:{id:i}}),[c]=(0,f.oY)({variables:{combatant:{campaignId:i,encounterId:l,name:"New Combatant",turnOrder:(null!==(t=null===(n=P()(o,"turnOrder"))||void 0===n?void 0:n.turnOrder)&&void 0!==t?t:0)+1}},refetchQueries:[f.N8]}),[u]=(0,f.hU)({refetchQueries:[f.N8]}),m=(0,v.useMemo)(()=>({combatants:o.map(e=>{var n;return{..._()(e,"__typename","player"),campaignId:i,encounterId:l,playerId:null===(n=e.player)||void 0===n?void 0:n.id}})}),[o,i,l]),h=(0,v.useMemo)(()=>{var e;return(null!==(a=null==d?void 0:null===(e=d.campaign)||void 0===e?void 0:e.players)&&void 0!==a?a:[]).filter(e=>!e.isGM)},[d]),x=(0,v.useCallback)(e=>{let n=e.combatants.map((e,n)=>({...e,turnOrder:n+1}));u({variables:{combatants:n}})},[u]);return(0,r.jsx)(s.J9,{initialValues:m,onSubmit:x,enableReinitialize:!0,children:e=>{let n=e.values.combatants.map(e=>e.id),t=n=>{e.setValues({combatants:n.map((n,t)=>{let r=I()(e.values.combatants.find(e=>e.id===n));return r.turnOrder=t+1,r})})};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(y.Z,{sx:{color:"#fff",zIndex:e=>e.zIndex.drawer+1},open:e.isSubmitting,children:(0,r.jsx)(g.Z,{color:"inherit"})}),(0,r.jsx)(C.t.Group,{axis:"y",values:n,onReorder:t,style:{padding:0},children:e.values.combatants.map((n,t)=>(0,r.jsx)(Y,{playerList:h,combatant:n,index:t,onDragEnd:e.submitForm},n.id))}),(0,r.jsx)(Z.Z,{sx:{display:"flex",justifyContent:"flex-end"},children:(0,r.jsxs)(b.Z,{variant:"contained",color:"success",onClick:()=>c(),children:[(0,r.jsx)(N.Z,{})," New Combatant"]})})]})}})}let K=j.Ry().shape({name:j.Z_().required("Campaign Name is required")});function ee(e){let{campaign:n,encounter:t}=e,[a]=(0,f.$p)(),i=(0,v.useMemo)(()=>({name:t.name,hideMonsterNames:t.hideMonsterNames}),[t.name,t.hideMonsterNames]),l=(0,v.useCallback)(async e=>{a({variables:{encounter:{id:t.id,name:e.name,campaignId:n.id,hideMonsterNames:e.hideMonsterNames}}})},[t.id,n.id,a]);return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(d.Z,{variant:"h3",children:"Edit Encounter"}),(0,r.jsx)(s.J9,{initialValues:i,enableReinitialize:!0,validationSchema:K,onSubmit:l,children:e=>{let{handleReset:n,isValid:t,dirty:a}=e;return(0,r.jsx)(s.l0,{children:(0,r.jsxs)(c.ZP,{container:!0,spacing:2,my:2,children:[(0,r.jsx)(c.ZP,{item:!0,xs:12,sm:8,children:(0,r.jsx)(s.gN,{name:"name",children:e=>{let{field:n,meta:t}=e;return(0,r.jsx)(u.Z,{required:!0,id:"name",label:"Encounter Name",fullWidth:!0,error:t.touched&&!!t.error,helperText:t.error,...n})}})}),(0,r.jsx)(c.ZP,{item:!0,xs:12,sm:4,children:(0,r.jsx)(s.gN,{name:"hideMonsterNames",children:e=>{let{field:n}=e;return(0,r.jsxs)(m.Z,{fullWidth:!0,children:[(0,r.jsx)(h.Z,{id:"hideMonsterNames",children:"Hide Monster Names"}),(0,r.jsxs)(x.Z,{labelId:"hideMonsterNamesLabel",id:"hideMonsterNames",label:"Hide Monster Names",...n,children:[(0,r.jsx)(p.Z,{value:f.NJ.Never,children:"Never"}),(0,r.jsx)(p.Z,{value:f.NJ.UntilTurn,children:"Until Their Turn"}),(0,r.jsx)(p.Z,{value:f.NJ.Always,children:"Always"})]})]})}})}),a&&(0,r.jsxs)(c.ZP,{item:!0,xs:12,sx:{textAlign:"right",order:"2"},children:[(0,r.jsx)(b.Z,{variant:"contained",color:"secondary",onClick:n,sx:{mr:2},children:"Reset"}),(0,r.jsx)(b.Z,{variant:"contained",color:"primary",disabled:!t,type:"submit",children:"Save"})]})]})})}}),(0,r.jsx)($,{campaignId:n.id,encounterId:t.id,combatants:t.combatants})]})}function en(){var e,n;let t=(0,o.useRouter)(),{campaignId:i,encounterId:s}=t.query,{data:d}=(0,f.mU)({variables:{id:i}}),{data:c}=(0,f.VV)({variables:{campaignId:i,encounterId:s},skip:!(i&&s)});return(null==d?void 0:d.campaign)&&(null==c?void 0:null===(e=c.campaign)||void 0===e?void 0:e.encounter)&&(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(l(),{children:(0,r.jsx)("title",{children:"".concat(null!==(n=d.campaign.name)&&void 0!==n?n:"Campaign"," Details | OBS GM Overlay")})}),(0,r.jsx)(a.Z,{fixed:!0,children:(0,r.jsx)(ee,{campaign:d.campaign,encounter:c.campaign.encounter})})]})}},4505:function(e,n,t){"use strict";t.d(n,{J_:function(){return o},sG:function(){return a},qI:function(){return h},y1:function(){return x}});var r=t(3595);function a(e){return e instanceof Date?e:(0,r.D)(e)}var i=t(2290),l=t(2090);function o(e,n){var t;let r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:["hours","minutes","seconds"],a={xSeconds:"{{count}}",xMinutes:"{{count}}",xHours:"{{count}}"},o=(0,i.y)({start:e,end:n});return(0,l.L)(o,{format:r,locale:{formatDistance:(e,n)=>{var r;return null!==(t=null===(r=a[e])||void 0===r?void 0:r.replace("{{count}}",null==n?void 0:n.toString().padStart(2,"0")))&&void 0!==t?t:""}},delimiter:":",zero:!0}).replace(/^0(\d)/,"$1")}var s=t(7294),d=t(3337),c=t(3732),u=t(209);function m(e){let{player:n,campaign:t}=e;if(!n||!t||!t.gmInspiration&&n.isGM||"none"===t.cooldownType)return 0;let r=a("player"===t.cooldownType?n.lastInspirationUsed:t.lastInspirationUsed),i=(0,c.m)(r,t.cooldownTime),l=i>new Date,o=l?(0,u.c)(i,new Date):0;return o}function h(e){var n;let{player:t,campaign:r}=e,[a,i]=(0,s.useState)(m({player:t,campaign:r}));return(0,s.useEffect)(()=>{i(m({player:t,campaign:r}))},[t,r]),(0,d.Z)(()=>{i(m({player:t,campaign:r}))},r&&"none"===r.cooldownType?null:1e3),{cooldownTimeRemaining:a,percentComplete:Math.round(a/((null!==(n=null==r?void 0:r.cooldownTime)&&void 0!==n?n:0)*60)*100),formattedDuration:(0,l.L)({hours:Math.trunc(a/60/60),minutes:Math.trunc(a/60%60),seconds:Math.trunc(a%60)},{format:["hours","minutes","seconds"]})}}function x(e,n){let t=(0,s.useRef)();return(0,s.useCallback)(function(){for(var r=arguments.length,a=Array(r),i=0;i<r;i++)a[i]=arguments[i];let l=()=>{clearTimeout(t.current),e(...a)};clearTimeout(t.current),t.current=window.setTimeout(l,n)},[e,n])}}},function(e){e.O(0,[948,387,404,557,767,774,888,179],function(){return e(e.s=4241)}),_N_E=e.O()}]);
(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[373],{76388:(e,n,a)=>{(window.__NEXT_P=window.__NEXT_P||[]).push(["/[campaignId]/encounter/[encounterId]/edit",function(){return a(83330)}])},83330:(e,n,a)=>{"use strict";a.r(n),a.d(n,{default:()=>ea});var r=a(37876),l=a(87460),t=a(77328),i=a.n(t),s=a(89099),d=a(39593),o=a(61428),c=a(12809),u=a(33354),m=a(65621),x=a(98895),h=a(72080),p=a(4146),b=a(32643),j=a(14232),v=a(91408),A=a(57982),y=a(50869),g=a(65965),C=a(2312),f=a(92781),N=a(83360),I=a(92989),k=a(75367),M=a(75783),w=a.n(M),P=a(25001),_=a.n(P),F=a(74023),O=a.n(F),z=a(62758),D=a(26479),E=a(93890),S=a(52460),T=a(52039),R=a(36448),V=a(77720),q=a(94527),L=a(65657),B=a(97444),W=a(34293),Q=a(59256),G=a(72528),H=a(57947),U=a(76947),X=a(68161),Y=a(45581);let $=(0,H.Ay)(u.A)(e=>{let{theme:n}=e;return{"& input.Mui-disabled":{cursor:"not-allowed",color:n.palette.text.primary,textFillColor:n.palette.text.primary}}}),K=(0,H.Ay)(E.A)(e=>{let{theme:n}=e;return{"& .MuiFormControlLabel-label.Mui-disabled":{cursor:"not-allowed",color:n.palette.text.primary,textFillColor:n.palette.text.primary}}});function J(e){let{playerList:n,combatant:a,index:l,onDragEnd:t}=e,[i,s]=(0,j.useState)(!1),o=(0,X.m)(),u=(0,d.j7)(),[v]=(0,A.n8)({variables:{id:a.id},refetchQueries:[A.ki]}),y=u.handleSubmit.bind(u);return(0,r.jsxs)(Y.N,{value:a.id,dragListener:!1,dragControls:o,onDragEnd:t,style:{listStyle:"none",margin:0,marginBottom:16,padding:0,position:"relative"},children:[(0,r.jsx)(S.A,{children:(0,r.jsxs)(T.A,{children:[(0,r.jsx)(U.A,{width:40,children:(0,r.jsx)(z.A,{onPointerDown:e=>o.start(e),style:{cursor:"grab",position:"absolute",top:"50%",left:8,transform:"translateY(-50%)"}})}),(0,r.jsxs)(c.A,{container:!0,spacing:2,alignItems:"center",ml:2,pr:6,mb:-1,children:[(0,r.jsx)(c.A,{size:{xs:12,md:5},children:(0,r.jsx)(d.D0,{name:"combatants[".concat(l,"].name"),children:e=>{var n;let{field:a,form:t,meta:i}=e,s=!!(null==(n=t.values.combatants[l])?void 0:n.playerId)||t.isSubmitting;return(0,r.jsx)(R.A,{title:s?"Controlled by Player Preset":void 0,placement:"top",followCursor:!0,children:(0,r.jsx)("span",{children:(0,r.jsx)($,{required:!0,id:"combatants[".concat(l,"].name"),label:"Name",fullWidth:!0,autoFocus:!0,disabled:s,error:i.touched&&!!i.error,helperText:i.touched?i.error:void 0,...a,onBlur:()=>{y()}})})})}})}),(0,r.jsx)(c.A,{size:{xs:8,md:5},children:(0,r.jsx)(d.D0,{name:"combatants[".concat(l,"].playerId"),children:e=>{let{field:a,form:t}=e,i=n.find(e=>e.id===a.value),s=n.filter(e=>(null==i?void 0:i.id)===e.id||!t.values.combatants.map(e=>e.playerId).includes(e.id));return(0,r.jsxs)(m.A,{fullWidth:!0,children:[(0,r.jsxs)(x.A,{id:"combatants[".concat(l,"].playerId"),children:["Player Preset"," ",s.length?"":"(No Players Available)"]}),(0,r.jsx)(h.A,{labelId:"playerIdLabel",id:"combatants[".concat(l,"].playerId"),label:"Player Preset",disabled:!s.length||t.isSubmitting,...a,value:a.value||"",endAdornment:(0,r.jsx)(D.A,{sx:{color:"grey.800",marginRight:2,cursor:"pointer",display:a.value?"":"none"},onClick:()=>{t.setFieldValue("combatants[".concat(l,"].playerId"),void 0),y()}}),onChange:e=>{let r=n.find(n=>n.id===e.target.value);a.onChange(e),t.setFieldValue("combatants[".concat(l,"].name"),r.characterName),t.setFieldValue("combatants[".concat(l,"].public"),!0),y()},children:s.map(e=>(0,r.jsxs)(p.A,{value:e.id,children:[e.playerName," (",e.characterName,")"]},"".concat(l,"_").concat(e.id)))})]})}})}),(0,r.jsx)(c.A,{size:{xs:2,md:1},sx:{display:"flex",justifyContent:"center"},children:(0,r.jsx)(d.D0,{name:"combatants[".concat(l,"].public"),children:e=>{var n;let{field:a,form:t}=e,i=!!(null==(n=t.values.combatants[l])?void 0:n.playerId)||t.isSubmitting;return(0,r.jsx)(R.A,{title:i?"Controlled by Player Preset":void 0,placement:"top",followCursor:!0,children:(0,r.jsx)("span",{children:(0,r.jsx)(K,{id:"combatants[".concat(l,"].public"),label:"Public",labelPlacement:"start",control:(0,r.jsx)(V.A,{color:"primary",checked:a.value,disabled:i,sx:{cursor:i?"not-allowed":"default"},...a,onChange:e=>{a.onChange(e),y()}})})})})}})}),(0,r.jsx)(c.A,{size:{xs:2,md:1},sx:{display:"flex",justifyContent:"flex-end"},children:(0,r.jsx)(q.A,{onClick:()=>s(!0),children:(0,r.jsx)(f.A,{})})})]})]})}),(0,r.jsxs)(L.A,{open:i,onClose:()=>s(!1),children:[(0,r.jsxs)(B.A,{children:["Delete combatant ",a.name,"?"]}),(0,r.jsx)(W.A,{children:(0,r.jsx)(Q.A,{children:"This action cannot be undone."})}),(0,r.jsxs)(G.A,{children:[(0,r.jsx)(b.A,{variant:"contained",onClick:()=>s(!1),children:"Cancel"}),(0,r.jsxs)(b.A,{variant:"contained",onClick:()=>{v(),s(!1)},color:"error",children:[(0,r.jsx)(f.A,{})," Delete"]})]})]})]},a.id)}function Z(e){var n,a;let{campaignId:l,encounterId:t,combatants:i}=e,{data:s}=(0,A.N$)({variables:{id:l}}),[o,{loading:c}]=(0,A.hm)({variables:{combatant:{campaignId:l,encounterId:t,name:"New Combatant",turnOrder:(null!=(a=null==(n=_()(i,"turnOrder"))?void 0:n.turnOrder)?a:0)+1}},refetchQueries:[A.ki]}),[u,{loading:m}]=(0,A.g9)({refetchQueries:[A.ki]}),x=(0,j.useMemo)(()=>({combatants:i.map(e=>{var n;return{...O()(e,"__typename","player"),campaignId:l,encounterId:t,playerId:null==(n=e.player)?void 0:n.id}})}),[i,l,t]),h=(0,j.useMemo)(()=>{var e,n;return(null!=(n=null==s||null==(e=s.campaign)?void 0:e.players)?n:[]).filter(e=>!e.isGM)},[s]),p=(0,j.useMemo)(()=>h.filter(e=>!i.some(n=>{var a;return(null==(a=n.player)?void 0:a.id)===e.id})),[h,i]),v=(0,j.useCallback)(()=>{u({variables:{combatants:[]}})},[u]),M=(0,j.useCallback)(()=>{let e=p.map((e,n)=>{var a,r;return{campaignId:l,encounterId:t,name:e.characterName||e.playerName,public:!0,turnOrder:(null!=(r=null==(a=_()(i,"turnOrder"))?void 0:a.turnOrder)?r:0)+n+1,playerId:e.id}});u({variables:{combatants:i.map(e=>{var n;return{campaignId:l,encounterId:t,id:e.id,public:e.public,name:e.name,playerId:null==(n=e.player)?void 0:n.id,turnOrder:e.turnOrder}}).concat(e)}})},[p,i,l,t,u]),P=(0,j.useCallback)(e=>u({variables:{combatants:e.combatants.map((e,n)=>({...e,turnOrder:n+1}))}}),[u]);return(0,r.jsx)(d.l1,{initialValues:x,onSubmit:P,enableReinitialize:!0,children:e=>{let n=e.values.combatants.map(e=>e.id);return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(y.A,{sx:{color:"#fff",zIndex:e=>e.zIndex.drawer+1},open:m||c,children:(0,r.jsx)(g.A,{color:"inherit"})}),(0,r.jsx)(k.x,{axis:"y",values:n,onReorder:n=>{e.setValues({combatants:n.map((n,a)=>{let r=w()(e.values.combatants.find(e=>e.id===n));return r.turnOrder=a+1,r})})},style:{padding:0},children:e.values.combatants.map((n,a)=>(0,r.jsx)(J,{playerList:h,combatant:n,index:a,onDragEnd:e.submitForm},n.id))}),(0,r.jsxs)(C.A,{sx:{display:"flex",justifyContent:"space-between"},children:[(0,r.jsx)("div",{children:(0,r.jsxs)(b.A,{variant:"contained",color:"error",onClick:v,children:[(0,r.jsx)(f.A,{})," Clear Combatants"]})}),(0,r.jsxs)("div",{children:[p.length>0&&(0,r.jsxs)(b.A,{variant:"contained",color:"primary",onClick:M,style:{marginRight:8},children:[(0,r.jsx)(N.A,{})," Add All PCs"]}),(0,r.jsxs)(b.A,{variant:"contained",color:"success",onClick:o,children:[(0,r.jsx)(I.A,{})," New Combatant"]})]})]})]})}})}let ee=v.Ik().shape({name:v.Yj().required("Campaign Name is required")});function en(e){let{campaign:n,encounter:a}=e,[l]=(0,A.BE)(),t=(0,j.useMemo)(()=>({name:a.name,hideMonsterNames:a.hideMonsterNames}),[a.name,a.hideMonsterNames]),i=(0,j.useCallback)(async e=>{l({variables:{encounter:{id:a.id,name:e.name,campaignId:n.id,hideMonsterNames:e.hideMonsterNames}}})},[a.id,n.id,l]);return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(o.A,{variant:"h3",children:"Edit Encounter"}),(0,r.jsx)(d.l1,{initialValues:t,enableReinitialize:!0,validationSchema:ee,onSubmit:i,children:e=>{let{handleReset:n,isValid:a,dirty:l}=e;return(0,r.jsx)(d.lV,{children:(0,r.jsxs)(c.A,{container:!0,spacing:2,my:2,children:[(0,r.jsx)(c.A,{size:{xs:12,sm:8},children:(0,r.jsx)(d.D0,{name:"name",children:e=>{let{field:n,meta:a}=e;return(0,r.jsx)(u.A,{required:!0,id:"name",label:"Encounter Name",fullWidth:!0,error:a.touched&&!!a.error,helperText:a.error,...n})}})}),(0,r.jsx)(c.A,{size:{xs:12,sm:4},children:(0,r.jsx)(d.D0,{name:"hideMonsterNames",children:e=>{let{field:n}=e;return(0,r.jsxs)(m.A,{fullWidth:!0,children:[(0,r.jsx)(x.A,{id:"hideMonsterNames",children:"Hide Monster Names"}),(0,r.jsxs)(h.A,{labelId:"hideMonsterNamesLabel",id:"hideMonsterNames",label:"Hide Monster Names",...n,children:[(0,r.jsx)(p.A,{value:A.F3.Never,children:"Never"}),(0,r.jsx)(p.A,{value:A.F3.UntilTurn,children:"Until Their Turn"}),(0,r.jsx)(p.A,{value:A.F3.Always,children:"Always"})]})]})}})}),l&&(0,r.jsxs)(c.A,{size:{xs:12},sx:{textAlign:"right",order:"2"},children:[(0,r.jsx)(b.A,{variant:"contained",color:"secondary",onClick:n,sx:{mr:2},children:"Reset"}),(0,r.jsx)(b.A,{variant:"contained",color:"primary",disabled:!a,type:"submit",children:"Save"})]})]})})}}),(0,r.jsx)(Z,{campaignId:n.id,encounterId:a.id,combatants:a.combatants})]})}function ea(){var e,n;let{campaignId:a,encounterId:t}=(0,s.useRouter)().query,{data:d}=(0,A.N$)({variables:{id:a}}),{data:o}=(0,A.Ki)({variables:{campaignId:a,encounterId:t},skip:!(a&&t)});return(null==d?void 0:d.campaign)&&(null==o||null==(e=o.campaign)?void 0:e.encounter)&&(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(i(),{children:(0,r.jsx)("title",{children:"".concat(null!=(n=d.campaign.name)?n:"Campaign"," Details | OBS GM Overlay")})}),(0,r.jsx)(l.A,{fixed:!0,children:(0,r.jsx)(en,{campaign:d.campaign,encounter:o.campaign.encounter})})]})}}},e=>{e.O(0,[46,798,632,930,23,100,636,593,792],()=>e(e.s=76388)),_N_E=e.O()}]);